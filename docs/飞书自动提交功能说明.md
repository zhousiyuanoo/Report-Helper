# 飞书自动提交功能说明

## 功能概述

飞书自动提交功能已成功集成到牛马日报助手中，实现了工作报告的自动化提交。该功能可以根据配置的时间自动生成并提交日报、周报和月报到指定的飞书群聊。

## 主要特性

### 1. 自动调度提交
- **智能时间检测**：根据配置的提交时间自动检测是否需要提交报告
- **多报告类型支持**：支持日报、周报、月报的自动提交
- **灵活时间配置**：可自定义各类报告的提交时间
- **防重复提交**：自动记录提交状态，避免重复提交

### 2. 配置管理
- **启用/禁用控制**：可随时启用或禁用自动提交功能
- **检查间隔设置**：可配置自动检查的时间间隔（分钟）
- **提前提交设置**：日报可设置提前几小时提交
- **时间点配置**：周报和月报可设置具体的提交时间点

### 3. 报告生成集成
- **自动内容生成**：调用现有的报告生成器生成报告内容
- **多种格式支持**：支持文本、卡片、Markdown等消息格式
- **智能内容处理**：根据工作日志自动生成专业的报告内容

## 配置说明

### 飞书应用配置
在设置窗口的"飞书设置"选项卡中配置以下信息：

1. **基础配置**
   - `App ID`：飞书应用的App ID
   - `App Secret`：飞书应用的App Secret
   - `群聊ID`：目标群聊的Chat ID
   - `消息格式`：选择消息发送格式（文本/卡片/Markdown）

2. **自动汇报设置**
   - `启用自动汇报检查`：开启/关闭自动提交功能
   - `检查间隔(分钟)`：设置自动检查的时间间隔，默认30分钟
   - `日报提前提交时间(小时)`：日报提前提交的小时数，默认2小时
   - `周报提交时间`：周报的提交时间点，默认20:00
   - `月报提交时间`：月报的提交时间点，默认20:00

### 提交时间逻辑

#### 日报提交
- **截止时间**：每天18:00
- **提交时间**：截止时间前N小时（可配置，默认2小时）
- **实际提交时间**：16:00（18:00 - 2小时）

#### 周报提交
- **截止时间**：每周五23:59:59
- **提交时间**：每周五的配置时间点（默认20:00）

#### 月报提交
- **截止时间**：每月最后一天23:59:59
- **提交时间**：每月最后一天的配置时间点（默认20:00）

## 技术实现

### 核心组件

1. **FeishuScheduler（飞书调度器）**
   - 文件：`feishu_scheduler.py`
   - 功能：负责自动检查和提交报告的调度逻辑
   - 主要方法：
     - `start()`：启动调度器
     - `stop()`：停止调度器
     - `force_check()`：强制执行一次检查
     - `test_report_submission()`：测试报告提交功能

2. **FeishuClient（飞书客户端）**
   - 文件：`feishu_client.py`
   - 功能：处理与飞书API的交互
   - 主要方法：
     - `check_and_auto_submit()`：检查并自动提交报告
     - `get_report_deadlines()`：获取报告截止时间信息
     - `send_report()`：发送报告到飞书群聊

3. **ConfigManager（配置管理器）**
   - 文件：`config_manager.py`
   - 功能：管理应用程序配置
   - 新增方法：`get_config()`：获取完整配置信息

### 集成点

1. **主程序集成**（`main.py`）
   - 在`ApplicationManager`中初始化`FeishuScheduler`
   - 应用启动时自动启动调度器
   - 应用退出时自动停止调度器
   - 设置更改时重启调度器

2. **设置界面集成**（`settings_window.py`）
   - 在飞书设置选项卡中添加自动汇报配置UI
   - 支持配置的加载和保存
   - 飞书启用状态变化时自动启用/禁用相关控件

## 使用方法

### 1. 配置飞书应用
1. 在飞书开放平台创建应用
2. 获取App ID和App Secret
3. 将应用添加到目标群聊
4. 获取群聊的Chat ID

### 2. 配置应用设置
1. 打开牛马日报助手
2. 进入"设置" → "飞书设置"
3. 填写飞书应用信息
4. 启用"飞书集成"
5. 配置自动汇报设置
6. 保存设置

### 3. 验证功能
1. 在飞书设置中点击"测试连接"验证配置
2. 使用测试脚本验证自动提交逻辑
3. 观察应用日志确认调度器正常运行

## 测试工具

### 1. 基础功能测试
```bash
python test_feishu_auto_submit.py
```
- 测试飞书配置
- 测试飞书客户端连接
- 测试调度器初始化

### 2. 启用状态测试
```bash
python test_feishu_enabled.py
```
- 模拟启用状态下的功能测试
- 验证配置加载和调度逻辑
- 测试报告生成和提交流程

## 日志和监控

### 日志位置
- 应用日志：`logs/app_YYYYMMDD.log`
- 调度器日志：包含在应用日志中，标识为`feishu_scheduler`

### 关键日志信息
- 调度器启动/停止状态
- 自动检查执行情况
- 报告提交成功/失败记录
- 配置更新和重启信息

## 故障排除

### 常见问题

1. **调度器启动失败**
   - 检查飞书配置是否完整
   - 确认App ID和App Secret正确
   - 验证群聊ID有效性

2. **报告提交失败**
   - 检查网络连接
   - 验证飞书应用权限
   - 确认群聊中包含该应用

3. **时间检查异常**
   - 检查系统时间设置
   - 验证配置的提交时间格式
   - 确认时区设置正确

### 调试方法

1. **启用详细日志**
   - 修改日志级别为DEBUG
   - 观察详细的执行流程

2. **手动测试**
   - 使用`force_check()`方法手动触发检查
   - 使用`test_report_submission()`测试提交功能

3. **配置验证**
   - 使用飞书设置中的"测试连接"功能
   - 检查配置文件中的相关设置

## 更新历史

### v1.0.0 (2025-07-19)
- ✅ 实现飞书自动提交调度器
- ✅ 集成到主程序和设置界面
- ✅ 支持日报、周报、月报自动提交
- ✅ 添加配置管理和状态监控
- ✅ 提供完整的测试工具
- ✅ 修复ConfigManager.get_config()方法

## 技术支持

如遇到问题，请：
1. 查看应用日志文件
2. 运行测试脚本诊断问题
3. 检查飞书应用配置和权限
4. 验证网络连接和防火墙设置

---

**注意**：使用前请确保已正确配置飞书应用，并具有相应的群聊管理权限。